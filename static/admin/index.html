<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>CMS</title>
    <!-- Required for Netlify Identity invite/recovery tokens (e.g. /#invite_token=...) -->
    <!-- Local copy to avoid adblock / third-party script failures -->
    <script src="/vendor-netlify-identity-widget.js"></script>
  </head>
  <body>
    <div id="nc-root"></div>
    <script>
      // IMPORTANT: Decap CMS mutates window.location.hash very early during boot.
      // Netlify Identity invite/recovery tokens are stored in the hash, so we must
      // handle those *before* loading Decap.
      (function () {
        const hash = window.location.hash || '';
        const isInvite = hash.includes('invite_token=');
        const isRecovery = hash.includes('recovery_token=');
        const isConfirmation = hash.includes('confirmation_token=');
        const isEmailChange = hash.includes('email_change_token=');
        const hasToken = isInvite || isRecovery || isConfirmation || isEmailChange;
        const statusEl = document.createElement('p');
        statusEl.style.cssText =
          'font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,Helvetica,Arial,sans-serif;' +
          'font-size:14px;opacity:.8;margin:12px 14px';
        statusEl.textContent = 'Loading CMSâ€¦';
        document.body.insertBefore(statusEl, document.body.firstChild);

        // Never boot Decap with a token in the hash: Decap will rewrite the hash and break the flow.
        // Instead, hand off to a dedicated token handler page.
        if (hasToken) {
          window.location.replace(`/identity/${hash}`);
          return;
        }

        const loadDecap = () => {
          const s = document.createElement('script');
          s.src = '/admin/decap-cms.js';
          s.defer = true;
          document.body.appendChild(s);
        };

        const waitForIdentity = (timeoutMs = 8000) =>
          new Promise((resolve) => {
            const start = Date.now();
            const tick = () => {
              if (window.netlifyIdentity) return resolve(window.netlifyIdentity);
              if (Date.now() - start > timeoutMs) return resolve(null);
              setTimeout(tick, 50);
            };
            tick();
          });

        // Normal flow: ensure Identity is available before booting Decap.
        // If Decap boots first, the "Login with Netlify Identity" button can render disabled.
        waitForIdentity(5000).then((ni) => {
          if (!ni) {
            statusEl.textContent =
              'Netlify Identity widget did not load. Check /vendor-netlify-identity-widget.js is deployed.';
            return;
          }
          statusEl.remove();
          loadDecap();
        });
      })();
    </script>
  </body>
</html>
