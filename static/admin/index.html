<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>CMS</title>
    <!-- Required for Netlify Identity invite/recovery tokens (e.g. /#invite_token=...) -->
    <script src="https://identity.netlify.com/v1/netlify-identity-widget.js" defer></script>
  </head>
  <body>
    <div id="nc-root"></div>
    <script>
      // IMPORTANT: Decap CMS mutates window.location.hash very early during boot.
      // Netlify Identity invite/recovery tokens are stored in the hash, so we must
      // handle those *before* loading Decap.
      (function () {
        const hash = window.location.hash || '';
        const isInvite = hash.includes('invite_token=');
        const isRecovery = hash.includes('recovery_token=');
        const isConfirmation = hash.includes('confirmation_token=');
        const isEmailChange = hash.includes('email_change_token=');
        const hasToken = isInvite || isRecovery || isConfirmation || isEmailChange;

        const loadDecap = () => {
          const s = document.createElement('script');
          s.src = '/admin/decap-cms.js';
          s.defer = true;
          document.body.appendChild(s);
        };

        const waitForIdentity = (timeoutMs = 8000) =>
          new Promise((resolve) => {
            const start = Date.now();
            const tick = () => {
              if (window.netlifyIdentity) return resolve(window.netlifyIdentity);
              if (Date.now() - start > timeoutMs) return resolve(null);
              setTimeout(tick, 50);
            };
            tick();
          });

        const startIdentityFlow = async () => {
          const ni = await waitForIdentity();
          if (!ni) {
            // If identity widget failed to load, fall back to Decap.
            loadDecap();
            return;
          }

          ni.on('init', (user) => {
            if (hasToken) {
              // Invite tokens should open signup; others can open login.
              ni.open(isInvite ? 'signup' : 'login');
            }

            if (!user) {
              ni.on('login', () => {
                // Drop token fragments and return to the CMS root (Decap will load then).
                window.location.href = '/admin/';
              });
            }
          });

          ni.init();
        };

        if (hasToken) {
          // Token flow: handle identity first, then reload to /admin/ to boot Decap.
          startIdentityFlow();
        } else {
          // Normal flow: boot Decap immediately.
          loadDecap();
        }
      })();
    </script>
  </body>
</html>
